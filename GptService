package com.example.An_Yang.service;

import com.example.An_Yang.domain.ChatHistory;
import com.example.An_Yang.repository.ChatHistoryRepository;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.JsonNode;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Map;
import java.util.HashMap;

@Service
public class GptService {

    @Value("${openai.api-key}")
    private String apiKey;

    @Value("${openai.model}")
    private String model;

    @Value("${openai.max-tokens}")
    private int maxTokens;

    @Value("${openai.temperature}")
    private double temperature;

    private final RestTemplate restTemplate;
    private final ChatHistoryRepository chatHistoryRepository;
    private final ObjectMapper objectMapper;

    public GptService(ChatHistoryRepository chatHistoryRepository) {
        this.chatHistoryRepository = chatHistoryRepository;
        this.restTemplate = new RestTemplate();
        this.objectMapper = new ObjectMapper();
    }

    public String getGptResponse(String userQuestion) {
        try {
            // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì„¤ì • (ì‚¬ì¥ë‹˜ ë„ìš°ë¯¸ ì—­í• )
            String systemPrompt = "ë‹¹ì‹ ì€ ì°½ì—… ì „ë¬¸ê°€ 'ì‚¬ì¥ë‹˜ ë„ìš°ë¯¸'ì…ë‹ˆë‹¤. " +
                    "ì‚¬ìš©ìì˜ ì°½ì—… ê´€ë ¨ ì§ˆë¬¸ì— ëŒ€í•´ ì‹¤ìš©ì ì´ê³  êµ¬ì²´ì ì¸ ì¡°ì–¸ì„ ì œê³µí•´ì£¼ì„¸ìš”. " +
                    "í•œêµ­ì–´ë¡œ ì¹œê·¼í•˜ê³  ì´í•´í•˜ê¸° ì‰½ê²Œ ë‹µë³€í•´ì£¼ì„¸ìš”. " +
                    "ì°½ì—… ì´ˆë³´ìë„ ì´í•´í•  ìˆ˜ ìˆë„ë¡ ë‹¨ê³„ë³„ë¡œ ì„¤ëª…í•´ì£¼ì„¸ìš”.";

            // OpenAI API ìš”ì²­ ë°ì´í„° êµ¬ì„±
            Map<String, Object> requestBody = new HashMap<>();
            requestBody.put("model", model);
            requestBody.put("max_tokens", maxTokens);
            requestBody.put("temperature", temperature);

            List<Map<String, String>> messages = List.of(
                Map.of("role", "system", "content", systemPrompt),
                Map.of("role", "user", "content", userQuestion)
            );
            requestBody.put("messages", messages);

            // HTTP í—¤ë” ì„¤ì •
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_JSON);
            headers.setBearerAuth(apiKey);

            HttpEntity<Map<String, Object>> request = new HttpEntity<>(requestBody, headers);

            // OpenAI API í˜¸ì¶œ
            ResponseEntity<String> response = restTemplate.postForEntity(
                "https://api.openai.com/v1/chat/completions",
                request,
                String.class
            );

            // ì‘ë‹µ íŒŒì‹±
            JsonNode responseJson = objectMapper.readTree(response.getBody());
            String gptResponse = responseJson.get("choices").get(0).get("message").get("content").asText();

            // ì±„íŒ… íˆìŠ¤í† ë¦¬ì— ì €ì¥
            ChatHistory chatHistory = new ChatHistory(userQuestion, gptResponse, LocalDateTime.now());
            chatHistoryRepository.save(chatHistory);

            return gptResponse;

        } catch (Exception e) {
            e.printStackTrace();
            return "ì£„ì†¡í•©ë‹ˆë‹¤. ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
        }
    }

    public List<ChatHistory> getChatHistory() {
        return chatHistoryRepository.findAllOrderByAskedAtDesc(org.springframework.data.domain.PageRequest.of(0, 20));
    }

    // íì—… ë¦¬ìŠ¤í¬ ë¶„ì„ ê¸°ëŠ¥
    public String analyzeBusinessRisk(String businessType, String location, String investmentAmount, String experience) {
        try {
            String systemPrompt = "ë‹¹ì‹ ì€ ì°½ì—… ë¦¬ìŠ¤í¬ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. " +
                    "ì‚¬ìš©ìê°€ ì œê³µí•œ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ íì—… ë¦¬ìŠ¤í¬ë¥¼ ë¶„ì„í•˜ê³  êµ¬ì²´ì ì¸ ìœ„í—˜ ìš”ì†Œì™€ ëŒ€ì‘ ë°©ì•ˆì„ ì œì‹œí•´ì£¼ì„¸ìš”. " +
                    "ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”:\n\n" +
                    "ğŸ“Š íì—… ë¦¬ìŠ¤í¬ ë¶„ì„ ê²°ê³¼\n" +
                    "â€¢ ë¦¬ìŠ¤í¬ ë ˆë²¨: (ë†’ìŒ/ë³´í†µ/ë‚®ìŒ)\n" +
                    "â€¢ ì£¼ìš” ìœ„í—˜ ìš”ì†Œ:\n" +
                    "â€¢ ëŒ€ì‘ ë°©ì•ˆ:\n" +
                    "â€¢ ì¶”ê°€ ê³ ë ¤ì‚¬í•­:";

            String userPrompt = String.format(
                "ì‚¬ì—… ì¢…ë¥˜: %s\nìœ„ì¹˜: %s\níˆ¬ì ê¸ˆì•¡: %s\nê²½í—˜ ìˆ˜ì¤€: %s\n\nìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ íì—… ë¦¬ìŠ¤í¬ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”.",
                businessType, location, investmentAmount, experience
            );

            return callGptApi(systemPrompt, userPrompt);

        } catch (Exception e) {
            e.printStackTrace();
            return "ì£„ì†¡í•©ë‹ˆë‹¤. ë¦¬ìŠ¤í¬ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        }
    }

    // ì°½ì—… ì¶”ì²œ ê¸°ëŠ¥
    public String recommendBusiness(String businessType, String preferredLocation, String budget) {
        try {
            String systemPrompt = "ë‹¹ì‹ ì€ ì°½ì—… ì¶”ì²œ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. " +
                    "ì‚¬ìš©ìê°€ ì›í•˜ëŠ” ì‚¬ì—… ì¢…ë¥˜ì™€ ì„ í˜¸ ì§€ì—­, ì˜ˆì‚°ì„ ë°”íƒ•ìœ¼ë¡œ êµ¬ì²´ì ì¸ ì¶”ì²œì„ í•´ì£¼ì„¸ìš”. " +
                    "ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”:\n\n" +
                    "ğŸ¯ ì°½ì—… ì¶”ì²œ ê²°ê³¼\n" +
                    "â€¢ ì¶”ì²œ ì§€ì—­:\n" +
                    "â€¢ ì¶”ì²œ í”„ëœì°¨ì´ì¦ˆ/ë¸Œëœë“œ:\n" +
                    "â€¢ ì˜ˆìƒ íˆ¬ì ë¹„ìš©:\n" +
                    "â€¢ ì›” ì˜ˆìƒ ë§¤ì¶œ:\n" +
                    "â€¢ ì„±ê³µ íŒ:";

            String userPrompt = String.format(
                "ì›í•˜ëŠ” ì‚¬ì—…: %s\nì„ í˜¸ ì§€ì—­: %s\nì˜ˆì‚°: %s\n\nìœ„ ì¡°ê±´ì— ë§ëŠ” ì°½ì—…ì„ ì¶”ì²œí•´ì£¼ì„¸ìš”.",
                businessType, preferredLocation, budget
            );

            return callGptApi(systemPrompt, userPrompt);

        } catch (Exception e) {
            e.printStackTrace();
            return "ì£„ì†¡í•©ë‹ˆë‹¤. ì°½ì—… ì¶”ì²œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        }
    }

    // ê³µí†µ GPT API í˜¸ì¶œ ë©”ì„œë“œ
    private String callGptApi(String systemPrompt, String userPrompt) {
        try {
            Map<String, Object> requestBody = new HashMap<>();
            requestBody.put("model", model);
            requestBody.put("max_tokens", maxTokens);
            requestBody.put("temperature", temperature);

            List<Map<String, String>> messages = List.of(
                Map.of("role", "system", "content", systemPrompt),
                Map.of("role", "user", "content", userPrompt)
            );
            requestBody.put("messages", messages);

            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_JSON);
            headers.setBearerAuth(apiKey);

            HttpEntity<Map<String, Object>> request = new HttpEntity<>(requestBody, headers);

            ResponseEntity<String> response = restTemplate.postForEntity(
                "https://api.openai.com/v1/chat/completions",
                request,
                String.class
            );

            JsonNode responseJson = objectMapper.readTree(response.getBody());
            return responseJson.get("choices").get(0).get("message").get("content").asText();

        } catch (Exception e) {
            e.printStackTrace();
            return "ì£„ì†¡í•©ë‹ˆë‹¤. ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        }
    }
}


